<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Integration Test Runner</title>
  <script type="importmap">
    {
      "imports": {
        "@huggingface/transformers": "/node_modules/@huggingface/transformers/dist/transformers.min.js",
        "onnxruntime-web": "/node_modules/onnxruntime-web/dist/ort.min.js"
      }
    }
  </script>
</head>
<body>
  <div id="test-output"></div>
  <div id="test-status">Initializing...</div>
  <div id="llm-status-panel">
    <div data-testid="status">idle</div>
    <div data-testid="progress">0</div>
    <div data-testid="file">-</div>
    <button data-testid="start-warmup">Start</button>
  </div>
  
  <script type="module">
    const statusEl = document.querySelector('[data-testid="status"]');
    const progressEl = document.querySelector('[data-testid="progress"]');
    const fileEl = document.querySelector('[data-testid="file"]');
    const startBtn = document.querySelector('[data-testid="start-warmup"]');
    let provider;

    function initProvider() {
      try {
        if (!window.createAIProvider) return;
        provider = window.createAIProvider({
          llm: { model: 'onnx-community/Qwen2.5-0.5B-Instruct', device: 'wasm', dtype: 'q4', maxTokens: 20 }
        });

        provider.on('progress', ({ status, file, progress }) => {
          if (statusEl) statusEl.textContent = status;
          if (typeof progress === 'number' && progressEl) progressEl.textContent = String(Math.max(0, Math.min(100, Math.round(progress))));
          if (file && fileEl) fileEl.textContent = file;
        });

        provider.on('ready', () => {
          if (statusEl) statusEl.textContent = 'ready';
          if (progressEl) progressEl.textContent = '100';
        });

        provider.on('error', ({ error }) => {
          if (statusEl) statusEl.textContent = 'error';
          console.error(error);
        });

        window.startWarmup = () => provider.warmup('llm');
        if (startBtn) startBtn.addEventListener('click', () => window.startWarmup());
      } catch (e) {
        console.error('Failed to init provider', e);
      }
    }

    (async () => {
      try {
        // Dynamic import biblioteki jako ES Module
        const { createAIProvider } = await import('/dist/index.js');
        
        // Expose na window dla testów Playwright
        window.createAIProvider = createAIProvider;
        window.testResults = {};
        window.testReady = true;
        
        console.log('✅ Library imported successfully');
        // Inicjalizacja providera i UI po imporcie biblioteki
        initProvider();
      } catch (error) {
        console.error('❌ Failed to import library:', error);
        window.testReady = false;
        window.importError = error.message;
      }
    })();
    
    // Helper functions dla testów
    window.testHelpers = {
      async loadModel(config) {
        if (!window.createAIProvider) {
          throw new Error('Library not loaded yet');
        }
        const provider = window.createAIProvider(config);
        await provider.warmup();
        return provider;
      },
      
      async runInference(provider, input, options) {
        const start = performance.now();
        const result = await provider.chat(input, options);
        const duration = performance.now() - start;
        return { result, duration };
      },
      
      log(message) {
        const output = document.getElementById('test-output');
        const line = document.createElement('div');
        line.textContent = `[${new Date().toISOString()}] ${message}`;
        output.appendChild(line);
        console.log(message);
      }
    };
    
    document.getElementById('test-status').textContent = 'Ready for tests';
    console.log('Test environment ready');
  </script>
</body>
</html>


